import { pgTable, uuid, text, timestamp, boolean, index, pgEnum, integer } from 'drizzle-orm/pg-core';

/**
 * Changelog entry type enum
 */
export const changelogTypeEnum = pgEnum('changelog_type', [
  'milestone',    // Phase completed, major achievement
  'feature',      // New feature/deliverable completed
  'update',       // Progress update, status change
  'fix',          // Bug fix or issue resolved
  'blocker',      // Blocker identified or resolved
  'decision',     // Important decision made
  'note',         // General note or communication
]);

/**
 * Changelog entries table - tracks project progress over time
 */
export const changelogEntries = pgTable(
  'changelog_entries',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    
    // Entry content
    type: changelogTypeEnum('type').notNull(),
    title: text('title').notNull(),
    description: text('description'),
    
    // SOW reference (optional - for auto-generated entries)
    phaseId: integer('phase_id'),
    phaseName: text('phase_name'),
    deliverableName: text('deliverable_name'),
    
    // Status tracking (for blockers)
    previousStatus: text('previous_status'),
    newStatus: text('new_status'),
    
    // Metadata
    isAutoGenerated: boolean('is_auto_generated').default(false).notNull(),
    isPinned: boolean('is_pinned').default(false).notNull(),
    
    // Timestamps
    createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
    updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  },
  (table) => [
    index('changelog_type_idx').on(table.type),
    index('changelog_phase_idx').on(table.phaseId),
    index('changelog_created_idx').on(table.createdAt),
    index('changelog_pinned_idx').on(table.isPinned),
  ]
);

export type ChangelogEntry = typeof changelogEntries.$inferSelect;
export type NewChangelogEntry = typeof changelogEntries.$inferInsert;
