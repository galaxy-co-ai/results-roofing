'use client';

import { useState, useEffect, useCallback } from 'react';
import { 
  Plus,
  Milestone,
  Sparkles,
  RefreshCw,
  Wrench,
  AlertTriangle,
  Lightbulb,
  FileText,
  Filter,
  Pin,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogBody } from '@/components/ui/dialog';

type ChangelogType = 'milestone' | 'feature' | 'update' | 'fix' | 'blocker' | 'decision' | 'note';

interface ChangelogEntry {
  id: string;
  type: ChangelogType;
  title: string;
  description: string | null;
  phaseId: number | null;
  phaseName: string | null;
  deliverableName: string | null;
  previousStatus: string | null;
  newStatus: string | null;
  isAutoGenerated: boolean;
  isPinned: boolean;
  createdAt: string;
}

const TYPE_CONFIG: Record<ChangelogType, { icon: typeof Milestone; color: string; bg: string; label: string }> = {
  milestone: { icon: Milestone, color: 'text-violet-600', bg: 'bg-violet-100', label: 'Milestone' },
  feature: { icon: Sparkles, color: 'text-emerald-600', bg: 'bg-emerald-100', label: 'Feature' },
  update: { icon: RefreshCw, color: 'text-blue-600', bg: 'bg-blue-100', label: 'Update' },
  fix: { icon: Wrench, color: 'text-amber-600', bg: 'bg-amber-100', label: 'Fix' },
  blocker: { icon: AlertTriangle, color: 'text-rose-600', bg: 'bg-rose-100', label: 'Blocker' },
  decision: { icon: Lightbulb, color: 'text-cyan-600', bg: 'bg-cyan-100', label: 'Decision' },
  note: { icon: FileText, color: 'text-slate-600', bg: 'bg-slate-100', label: 'Note' },
};

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric' 
  });
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
  });
}

export default function ChangelogPage() {
  const [entries, setEntries] = useState<ChangelogEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<string>('all');
  const [showAddDialog, setShowAddDialog] = useState(false);
  const [newEntry, setNewEntry] = useState({
    type: 'update' as ChangelogType,
    title: '',
    description: '',
  });
  const [submitting, setSubmitting] = useState(false);

  const fetchEntries = useCallback(async () => {
    try {
      setLoading(true);
      const params = new URLSearchParams();
      if (filter !== 'all') params.set('type', filter);

      const res = await fetch(`/api/admin/changelog?${params}`);
      const data = await res.json();
      setEntries(data.entries || []);
    } catch (error) {
      console.error('Failed to fetch changelog:', error);
    } finally {
      setLoading(false);
    }
  }, [filter]);

  useEffect(() => {
    fetchEntries();
  }, [fetchEntries]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!newEntry.title.trim()) return;

    try {
      setSubmitting(true);
      const res = await fetch('/api/admin/changelog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newEntry),
      });

      if (res.ok) {
        setNewEntry({ type: 'update', title: '', description: '' });
        setShowAddDialog(false);
        fetchEntries();
      }
    } catch (error) {
      console.error('Failed to create entry:', error);
    } finally {
      setSubmitting(false);
    }
  }

  // Group entries by date
  const groupedEntries = entries.reduce((groups, entry) => {
    const date = formatDate(entry.createdAt);
    if (!groups[date]) groups[date] = [];
    groups[date].push(entry);
    return groups;
  }, {} as Record<string, ChangelogEntry[]>);

  return (
    <div className="max-w-3xl">
      {/* Header */}
      <header className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-semibold tracking-tight">Changelog</h1>
          <p className="text-sm text-muted-foreground mt-1">Project progress timeline</p>
        </div>
        <Button onClick={() => setShowAddDialog(true)} size="sm" className="gap-1.5">
          <Plus size={14} />
          Add Entry
        </Button>
      </header>

      {/* Filters */}
      <div className="flex items-center gap-2 mb-6">
        <Filter size={14} className="text-muted-foreground" />
        <div className="flex gap-1">
          {['all', ...Object.keys(TYPE_CONFIG)].map((type) => (
            <button
              key={type}
              onClick={() => setFilter(type)}
              className={`px-2.5 py-1 text-xs rounded-full transition-colors ${
                filter === type
                  ? 'bg-primary text-primary-foreground'
                  : 'text-muted-foreground hover:bg-muted'
              }`}
            >
              {type === 'all' ? 'All' : TYPE_CONFIG[type as ChangelogType].label}
            </button>
          ))}
        </div>
      </div>

      {/* Timeline */}
      {loading ? (
        <div className="flex items-center justify-center py-12 text-muted-foreground">
          Loading...
        </div>
      ) : entries.length === 0 ? (
        <div className="text-center py-12 text-muted-foreground">
          <FileText size={32} className="mx-auto mb-2 opacity-50" />
          <p>No changelog entries yet</p>
          <p className="text-xs mt-1">Add your first entry to start tracking progress</p>
        </div>
      ) : (
        <div className="space-y-8">
          {Object.entries(groupedEntries).map(([date, dayEntries]) => (
            <div key={date}>
              {/* Date Header */}
              <div className="flex items-center gap-3 mb-3">
                <span className="text-xs font-medium text-muted-foreground">{date}</span>
                <div className="flex-1 h-px bg-border" />
              </div>

              {/* Entries for this date */}
              <div className="space-y-3 pl-4 border-l-2 border-muted">
                {dayEntries.map((entry) => {
                  const config = TYPE_CONFIG[entry.type];
                  const Icon = config.icon;

                  return (
                    <div
                      key={entry.id}
                      className="relative pl-6 pb-3 group"
                    >
                      {/* Timeline dot */}
                      <div className={`absolute -left-[9px] top-0.5 w-4 h-4 rounded-full ${config.bg} flex items-center justify-center`}>
                        <Icon size={10} className={config.color} />
                      </div>

                      {/* Content */}
                      <div className="flex items-start gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <span className={`text-[10px] font-medium px-1.5 py-0.5 rounded ${config.bg} ${config.color}`}>
                              {config.label}
                            </span>
                            {entry.isPinned && (
                              <Pin size={10} className="text-amber-500" />
                            )}
                            {entry.isAutoGenerated && (
                              <span className="text-[10px] text-muted-foreground">auto</span>
                            )}
                          </div>
                          <h3 className="font-medium text-sm mt-1">{entry.title}</h3>
                          {entry.description && (
                            <p className="text-xs text-muted-foreground mt-0.5 line-clamp-2">
                              {entry.description}
                            </p>
                          )}
                          {entry.phaseName && (
                            <span className="inline-block text-[10px] text-muted-foreground mt-1">
                              Phase {entry.phaseId}: {entry.phaseName}
                            </span>
                          )}
                        </div>
                        <span className="text-[10px] text-muted-foreground whitespace-nowrap">
                          {formatTime(entry.createdAt)}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Add Entry Dialog */}
      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>
        <DialogContent size="sm">
          <DialogHeader>
            <DialogTitle>Add Changelog Entry</DialogTitle>
          </DialogHeader>
          <DialogBody className="p-4">
            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Type Selection */}
              <div>
                <label className="text-xs font-medium text-muted-foreground mb-2 block">Type</label>
                <div className="flex flex-wrap gap-1.5">
                  {Object.entries(TYPE_CONFIG).map(([type, config]) => (
                    <button
                      key={type}
                      type="button"
                      onClick={() => setNewEntry(prev => ({ ...prev, type: type as ChangelogType }))}
                      className={`flex items-center gap-1.5 px-2.5 py-1.5 text-xs rounded-md transition-colors ${
                        newEntry.type === type
                          ? `${config.bg} ${config.color}`
                          : 'bg-muted text-muted-foreground hover:bg-muted/80'
                      }`}
                    >
                      <config.icon size={12} />
                      {config.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Title */}
              <div>
                <label className="text-xs font-medium text-muted-foreground mb-1.5 block">Title</label>
                <input
                  type="text"
                  value={newEntry.title}
                  onChange={(e) => setNewEntry(prev => ({ ...prev, title: e.target.value }))}
                  placeholder="What happened?"
                  className="w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20"
                  required
                />
              </div>

              {/* Description */}
              <div>
                <label className="text-xs font-medium text-muted-foreground mb-1.5 block">
                  Description <span className="text-muted-foreground/50">(optional)</span>
                </label>
                <textarea
                  value={newEntry.description}
                  onChange={(e) => setNewEntry(prev => ({ ...prev, description: e.target.value }))}
                  placeholder="Add more details..."
                  rows={3}
                  className="w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none"
                />
              </div>

              {/* Submit */}
              <div className="flex justify-end gap-2 pt-2">
                <Button type="button" variant="ghost" size="sm" onClick={() => setShowAddDialog(false)}>
                  Cancel
                </Button>
                <Button type="submit" size="sm" disabled={submitting || !newEntry.title.trim()}>
                  {submitting ? 'Adding...' : 'Add Entry'}
                </Button>
              </div>
            </form>
          </DialogBody>
        </DialogContent>
      </Dialog>
    </div>
  );
}
