'use client';

import { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { 
  Plus,
  Milestone,
  Sparkles,
  RefreshCw,
  Wrench,
  AlertTriangle,
  Lightbulb,
  FileText,
  Filter,
  Pin,
  ArrowRight,
  Loader2,
  ChevronDown,
  Clock,
  Calendar,
  Tag,
  Zap,
  History,
} from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogBody } from '@/components/ui/dialog';
import styles from './page.module.css';

type ChangelogType = 'milestone' | 'feature' | 'update' | 'fix' | 'blocker' | 'decision' | 'note';

interface ChangelogEntry {
  id: string;
  type: ChangelogType;
  title: string;
  description: string | null;
  phaseId: number | null;
  phaseName: string | null;
  deliverableName: string | null;
  previousStatus: string | null;
  newStatus: string | null;
  isAutoGenerated: boolean;
  isPinned: boolean;
  createdAt: string;
}

const TYPE_CONFIG: Record<ChangelogType, { 
  icon: typeof Milestone; 
  label: string;
  styleClass: string;
}> = {
  milestone: { icon: Milestone, label: 'Milestone', styleClass: styles.typeMilestone },
  feature: { icon: Sparkles, label: 'Feature', styleClass: styles.typeFeature },
  update: { icon: RefreshCw, label: 'Update', styleClass: styles.typeUpdate },
  fix: { icon: Wrench, label: 'Fix', styleClass: styles.typeFix },
  blocker: { icon: AlertTriangle, label: 'Blocker', styleClass: styles.typeBlocker },
  decision: { icon: Lightbulb, label: 'Decision', styleClass: styles.typeDecision },
  note: { icon: FileText, label: 'Note', styleClass: styles.typeNote },
};

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (date.toDateString() === today.toDateString()) {
    return 'Today';
  }
  if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday';
  }

  return date.toLocaleDateString('en-US', { 
    weekday: 'short',
    month: 'short', 
    day: 'numeric', 
    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined,
  });
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
  });
}

const STATUS_LABELS: Record<string, string> = {
  backlog: 'Backlog',
  todo: 'To Do',
  in_progress: 'In Progress',
  review: 'Review',
  done: 'Done',
};

function formatFullDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    weekday: 'long',
    month: 'long', 
    day: 'numeric', 
    year: 'numeric',
  });
}

export default function ChangelogPage() {
  const [entries, setEntries] = useState<ChangelogEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<string>('all');
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [showAddDialog, setShowAddDialog] = useState(false);
  const [newEntry, setNewEntry] = useState({
    type: 'update' as ChangelogType,
    title: '',
    description: '',
  });
  const [submitting, setSubmitting] = useState(false);

  const toggleExpand = (id: string) => {
    setExpandedId(prev => prev === id ? null : id);
  };

  const hasExpandableContent = (entry: ChangelogEntry): boolean => {
    return !!(
      entry.description || 
      entry.phaseName || 
      entry.deliverableName || 
      (entry.previousStatus && entry.newStatus)
    );
  };

  const fetchEntries = useCallback(async () => {
    try {
      setLoading(true);
      const params = new URLSearchParams();
      if (filter !== 'all') params.set('type', filter);

      const res = await fetch(`/api/admin/changelog?${params}`);
      const data = await res.json();
      setEntries(data.entries || []);
    } catch (error) {
      console.error('Failed to fetch changelog:', error);
    } finally {
      setLoading(false);
    }
  }, [filter]);

  useEffect(() => {
    fetchEntries();
  }, [fetchEntries]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!newEntry.title.trim()) return;

    try {
      setSubmitting(true);
      const res = await fetch('/api/admin/changelog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newEntry),
      });

      if (res.ok) {
        setNewEntry({ type: 'update', title: '', description: '' });
        setShowAddDialog(false);
        fetchEntries();
      }
    } catch (error) {
      console.error('Failed to create entry:', error);
    } finally {
      setSubmitting(false);
    }
  }

  // Group entries by date
  const groupedEntries = entries.reduce((groups, entry) => {
    const date = formatDate(entry.createdAt);
    if (!groups[date]) groups[date] = [];
    groups[date].push(entry);
    return groups;
  }, {} as Record<string, ChangelogEntry[]>);

  return (
    <motion.div 
      className={styles.page}
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.3 }}
    >
      {/* Header */}
      <header className={styles.header}>
        <div className={styles.headerLeft}>
          <div className={styles.headerIcon}>
            <History size={24} />
          </div>
          <div>
            <h1 className={styles.headerTitle}>Changelog</h1>
            <p className={styles.headerSubtitle}>Auto-tracked project activity</p>
          </div>
        </div>
        <button onClick={() => setShowAddDialog(true)} className={styles.addButton}>
          <Plus size={14} />
          Add Entry
        </button>
      </header>

      {/* Filters */}
      <div className={styles.filters}>
        <Filter size={14} className={styles.filterIcon} />
        <div className={styles.filterGroup}>
          {['all', ...Object.keys(TYPE_CONFIG)].map((type) => (
            <button
              key={type}
              onClick={() => setFilter(type)}
              className={`${styles.filterBtn} ${filter === type ? styles.filterBtnActive : ''}`}
            >
              {type === 'all' ? 'All' : TYPE_CONFIG[type as ChangelogType].label}
            </button>
          ))}
        </div>
      </div>

      {/* Timeline */}
      {loading ? (
        <div className={styles.loading}>
          <Loader2 size={16} className={styles.loadingSpinner} />
          Loading changelog...
        </div>
      ) : entries.length === 0 ? (
        <motion.div 
          className={styles.empty}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <div className={styles.emptyIcon}>
            <FileText size={28} />
          </div>
          <h3 className={styles.emptyTitle}>No entries yet</h3>
          <p className={styles.emptyDesc}>
            Activity will appear here as you complete tasks
          </p>
        </motion.div>
      ) : (
        <div className={styles.timeline}>
          <AnimatePresence>
            {Object.entries(groupedEntries).map(([date, dayEntries], groupIndex) => (
              <motion.div 
                key={date}
                className={styles.dateGroup}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: groupIndex * 0.05 }}
              >
                {/* Date Header */}
                <div className={styles.dateHeader}>
                  <span className={styles.dateLabel}>{date}</span>
                  <div className={styles.dateLine} />
                </div>

                {/* Entries for this date */}
                <div className={styles.entriesList}>
                  {dayEntries.map((entry, entryIndex) => {
                    const config = TYPE_CONFIG[entry.type];
                    const Icon = config.icon;
                    const isExpanded = expandedId === entry.id;
                    const canExpand = hasExpandableContent(entry);

                    return (
                      <motion.div
                        key={entry.id}
                        className={`${styles.entry} ${isExpanded ? styles.entryExpanded : ''}`}
                        initial={{ opacity: 0, x: -10 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: groupIndex * 0.05 + entryIndex * 0.02 }}
                        onClick={() => canExpand && toggleExpand(entry.id)}
                        style={{ cursor: canExpand ? 'pointer' : 'default' }}
                      >
                        {/* Timeline dot */}
                        <div className={`${styles.entryDot} ${config.styleClass}`}>
                          <Icon size={8} />
                        </div>

                        {/* Content */}
                        <div className={styles.entryHeader}>
                          <span className={`${styles.entryBadge} ${config.styleClass}`}>
                            <Icon size={9} />
                            {config.label}
                          </span>
                          {entry.isPinned && (
                            <Pin size={10} className={styles.entryPinned} />
                          )}
                          {entry.isAutoGenerated && (
                            <span className={styles.entryAuto}>auto</span>
                          )}
                          <span className={styles.entryTime}>
                            {formatTime(entry.createdAt)}
                          </span>
                          {canExpand && (
                            <ChevronDown 
                              size={14} 
                              className={`${styles.expandIcon} ${isExpanded ? styles.expandIconRotated : ''}`}
                            />
                          )}
                        </div>

                        <h3 className={styles.entryTitle}>{entry.title}</h3>
                        
                        {/* Collapsed preview - show truncated description */}
                        {!isExpanded && entry.description && (
                          <p className={styles.entryDescPreview}>{entry.description}</p>
                        )}

                        {/* Expanded details */}
                        <AnimatePresence>
                          {isExpanded && (
                            <motion.div
                              className={styles.entryDetails}
                              initial={{ height: 0, opacity: 0 }}
                              animate={{ height: 'auto', opacity: 1 }}
                              exit={{ height: 0, opacity: 0 }}
                              transition={{ duration: 0.2, ease: 'easeInOut' }}
                            >
                              {entry.description && (
                                <div className={styles.detailSection}>
                                  <p className={styles.detailDesc}>{entry.description}</p>
                                </div>
                              )}

                              <div className={styles.detailGrid}>
                                {/* Date & Time */}
                                <div className={styles.detailItem}>
                                  <Calendar size={12} className={styles.detailIcon} />
                                  <span>{formatFullDate(entry.createdAt)}</span>
                                </div>
                                <div className={styles.detailItem}>
                                  <Clock size={12} className={styles.detailIcon} />
                                  <span>{formatTime(entry.createdAt)}</span>
                                </div>

                                {/* Type */}
                                <div className={styles.detailItem}>
                                  <Tag size={12} className={styles.detailIcon} />
                                  <span>Type: {config.label}</span>
                                </div>

                                {/* Source */}
                                <div className={styles.detailItem}>
                                  <Zap size={12} className={styles.detailIcon} />
                                  <span>{entry.isAutoGenerated ? 'Auto-generated' : 'Manual entry'}</span>
                                </div>

                                {/* Phase info */}
                                {entry.phaseName && (
                                  <div className={styles.detailItem}>
                                    <Milestone size={12} className={styles.detailIcon} />
                                    <span>Phase {entry.phaseId}: {entry.phaseName}</span>
                                  </div>
                                )}

                                {/* Deliverable */}
                                {entry.deliverableName && (
                                  <div className={styles.detailItem}>
                                    <Sparkles size={12} className={styles.detailIcon} />
                                    <span>Deliverable: {entry.deliverableName}</span>
                                  </div>
                                )}
                              </div>

                              {/* Status change */}
                              {entry.previousStatus && entry.newStatus && (
                                <div className={styles.detailStatusChange}>
                                  <span className={styles.statusLabel}>Status changed:</span>
                                  <div className={styles.statusFlow}>
                                    <span className={styles.statusPrev}>
                                      {STATUS_LABELS[entry.previousStatus] || entry.previousStatus}
                                    </span>
                                    <ArrowRight size={14} className={styles.statusArrowLarge} />
                                    <span className={styles.statusNew}>
                                      {STATUS_LABELS[entry.newStatus] || entry.newStatus}
                                    </span>
                                  </div>
                                </div>
                              )}
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </motion.div>
                    );
                  })}
                </div>
              </motion.div>
            ))}
          </AnimatePresence>
        </div>
      )}

      {/* Add Entry Dialog */}
      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>
        <DialogContent size="sm">
          <DialogHeader>
            <DialogTitle>Add Changelog Entry</DialogTitle>
          </DialogHeader>
          <DialogBody className="p-4">
            <form onSubmit={handleSubmit} className={styles.form}>
              {/* Type Selection */}
              <div className={styles.formGroup}>
                <label className={styles.formLabel}>Type</label>
                <div className={styles.typeSelector}>
                  {Object.entries(TYPE_CONFIG).map(([type, config]) => (
                    <button
                      key={type}
                      type="button"
                      onClick={() => setNewEntry(prev => ({ ...prev, type: type as ChangelogType }))}
                      className={`${styles.typeBtn} ${config.styleClass} ${
                        newEntry.type === type ? styles.typeBtnActive : ''
                      }`}
                    >
                      <config.icon size={12} />
                      {config.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Title */}
              <div className={styles.formGroup}>
                <label className={styles.formLabel}>Title</label>
                <input
                  type="text"
                  value={newEntry.title}
                  onChange={(e) => setNewEntry(prev => ({ ...prev, title: e.target.value }))}
                  placeholder="What happened?"
                  className={styles.formInput}
                  required
                />
              </div>

              {/* Description */}
              <div className={styles.formGroup}>
                <label className={styles.formLabel}>
                  Description <span className={styles.formLabelOptional}>(optional)</span>
                </label>
                <textarea
                  value={newEntry.description}
                  onChange={(e) => setNewEntry(prev => ({ ...prev, description: e.target.value }))}
                  placeholder="Add more details..."
                  className={`${styles.formInput} ${styles.formTextarea}`}
                />
              </div>

              {/* Submit */}
              <div className={styles.formActions}>
                <button 
                  type="button" 
                  className={styles.cancelBtn}
                  onClick={() => setShowAddDialog(false)}
                >
                  Cancel
                </button>
                <button 
                  type="submit" 
                  className={styles.submitBtn}
                  disabled={submitting || !newEntry.title.trim()}
                >
                  {submitting ? 'Adding...' : 'Add Entry'}
                </button>
              </div>
            </form>
          </DialogBody>
        </DialogContent>
      </Dialog>
    </motion.div>
  );
}
