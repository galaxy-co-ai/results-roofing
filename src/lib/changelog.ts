import { db } from '@/db';
import { changelogEntries, type NewChangelogEntry } from '@/db/schema';

type ChangelogType = 'milestone' | 'feature' | 'update' | 'fix' | 'blocker' | 'decision' | 'note';

interface LogOptions {
  type: ChangelogType;
  title: string;
  description?: string;
  phaseId?: number;
  phaseName?: string;
  deliverableName?: string;
  previousStatus?: string;
  newStatus?: string;
  isAutoGenerated?: boolean;
}

/**
 * Log a changelog entry
 */
export async function logChangelog(options: LogOptions): Promise<void> {
  try {
    const entry: NewChangelogEntry = {
      type: options.type,
      title: options.title,
      description: options.description || null,
      phaseId: options.phaseId || null,
      phaseName: options.phaseName || null,
      deliverableName: options.deliverableName || null,
      previousStatus: options.previousStatus || null,
      newStatus: options.newStatus || null,
      isAutoGenerated: options.isAutoGenerated ?? true,
      isPinned: false,
    };

    await db.insert(changelogEntries).values(entry);
  } catch (error) {
    // Log error but don't throw - changelog is non-critical
    console.error('Failed to log changelog entry:', error);
  }
}

/**
 * Log a task status change
 */
export async function logTaskStatusChange(
  taskTitle: string,
  previousStatus: string,
  newStatus: string
): Promise<void> {
  const statusLabels: Record<string, string> = {
    backlog: 'Backlog',
    todo: 'To Do',
    in_progress: 'In Progress',
    review: 'Review',
    done: 'Done',
  };

  const prevLabel = statusLabels[previousStatus] || previousStatus;
  const newLabel = statusLabels[newStatus] || newStatus;

  // Determine entry type based on new status
  let type: ChangelogType = 'update';
  let title = `Task moved: ${taskTitle}`;
  
  if (newStatus === 'done') {
    type = 'feature';
    title = `Completed: ${taskTitle}`;
  } else if (newStatus === 'in_progress') {
    type = 'update';
    title = `Started: ${taskTitle}`;
  } else if (newStatus === 'review') {
    type = 'update';
    title = `Ready for review: ${taskTitle}`;
  }

  await logChangelog({
    type,
    title,
    description: `${prevLabel} â†’ ${newLabel}`,
    previousStatus,
    newStatus,
    isAutoGenerated: true,
  });
}

/**
 * Log a task creation
 */
export async function logTaskCreated(taskTitle: string): Promise<void> {
  await logChangelog({
    type: 'note',
    title: `New task: ${taskTitle}`,
    isAutoGenerated: true,
  });
}

/**
 * Log a milestone (phase completion)
 */
export async function logMilestone(
  phaseName: string,
  phaseId: number,
  description?: string
): Promise<void> {
  await logChangelog({
    type: 'milestone',
    title: `Phase ${phaseId} complete: ${phaseName}`,
    description,
    phaseId,
    phaseName,
    isAutoGenerated: true,
  });
}

/**
 * Log feedback submission
 */
export async function logFeedbackReceived(
  feedbackType: string,
  preview: string
): Promise<void> {
  await logChangelog({
    type: 'note',
    title: `${feedbackType} feedback received`,
    description: preview.length > 100 ? preview.slice(0, 100) + '...' : preview,
    isAutoGenerated: true,
  });
}
